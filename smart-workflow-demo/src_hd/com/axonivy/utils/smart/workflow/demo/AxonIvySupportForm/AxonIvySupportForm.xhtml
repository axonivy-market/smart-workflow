<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions">
<h:body>
  <ui:composition template="/layouts/frame-10-full-width.xhtml">
    <ui:define name="title">#{ivy.cms.co('/Dialogs/com/axonivy/utils/smart/workflow/demo/AxonIvySupportForm/AxonIvySupport')}</ui:define>
    <ui:define name="content">
      <!-- Include support chat JavaScript -->
      <h:outputScript library="js" name="support-chat.js" />
      <h:outputStylesheet library="css" name="shopping-common.css" />
      <h:outputStylesheet library="css" name="support-chat.css" />

      <div class="card">
        <h:form id="chatForm">
          <p:panel header="#{ivy.cms.co('/Dialogs/com/axonivy/utils/smart/workflow/demo/AxonIvySupportForm/AxonIvySupport')}" 
            styleClass="w-full max-w-4xl mx-auto border-round-2xl shadow-2">

            <p:scrollPanel id="chatArea" mode="native"
              styleClass="overflow-y-auto chat-panel border-round chat-area">
              <ui:repeat value="#{chatBean.chatHistory}" var="msg">
                <p:outputPanel styleClass="flex align-items-end mb-3 #{msg.role eq 'user' ? 'flex-row-reverse' : 'flex-row'}">
                  <div class="msg-bubble inline-block #{msg.role eq 'user' ? 'user-bubble ml-auto' : 'bot-bubble mr-auto text-left'}">
                    <span class="msg-sender font-bold block mb-1">#{msg.role eq 'user' ? 'You' : 'Axon Ivy Support'}</span> 
                    <span class="msg-content">
                      <h:outputText value="#{msg.htmlContent}" escape="#{msg.role eq 'user'}" />
                    </span> 
                    <span class="msg-time block mt-1 text-right">#{msg.timestamp}</span>
                  </div>
                </p:outputPanel>
              </ui:repeat>
            </p:scrollPanel>

            <div class="field flex align-items-center mt-3">
              <p:inputTextarea id="userInput" value="#{chatBean.userMessage}" styleClass="flex-auto mr-3" 
                placeholder="#{ivy.cms.co('/Dialogs/com/axonivy/utils/smart/workflow/demo/AxonIvySupportForm/InputPlaceholder')}"
                onkeydown="return handleChatInputKeyDown(event);" />
              <p:commandButton id="sendBtn" value="#{ivy.cms.co('/Dialogs/com/axonivy/utils/smart/workflow/demo/AxonIvySupportForm/Send')}"
                icon="pi pi-send" onclick="return sendMessageWithValidation();" />
            </div>
          </p:panel>
          <p:remoteCommand name="sendMessage" actionListener="#{chatBean.sendMessage}" global="false"
            update="chatArea userInput" process="@form" oncomplete="getAnswer(); scrollChatToBottom();" />
          <p:remoteCommand name="getAnswer" actionListener="#{chatBean.getAnswer}" update="chatArea userInput"
            global="false" oncomplete="scrollChatToBottom();" />
        </h:form>
      </div>
    </ui:define>
  </ui:composition>
</h:body>

</html>
